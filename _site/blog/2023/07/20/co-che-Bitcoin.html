<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hiimvanhg</title>
    <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Cơ chế Bitcoin</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Cơ chế Bitcoin" />
<meta name="author" content="vanhg" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Với mỗi Miner, họ sẽ thông thường được connect với 8 người khác. Khi một Tx được gửi đến, Miners sẽ thông báo là nhận được Tx trên mạng P2P. Mọi miners sẽ xác thực rằng Tx đã nhận và lưu vào trong Mempool. Mempool là nơi chứa những Tx đang chờ được xử lý. Các nodes này chia sẻ dữ liệu mempool với nhau bằng cách chuyển tiếp các Tx đã kí với nhau cho đến khi nó được toàn bộ mạng lưới." />
<meta property="og:description" content="Với mỗi Miner, họ sẽ thông thường được connect với 8 người khác. Khi một Tx được gửi đến, Miners sẽ thông báo là nhận được Tx trên mạng P2P. Mọi miners sẽ xác thực rằng Tx đã nhận và lưu vào trong Mempool. Mempool là nơi chứa những Tx đang chờ được xử lý. Các nodes này chia sẻ dữ liệu mempool với nhau bằng cách chuyển tiếp các Tx đã kí với nhau cho đến khi nó được toàn bộ mạng lưới." />
<link rel="canonical" href="http://localhost:4000/blog/2023/07/20/co-che-Bitcoin" />
<meta property="og:url" content="http://localhost:4000/blog/2023/07/20/co-che-Bitcoin" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-07-20T00:00:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Cơ chế Bitcoin" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"vanhg"},"dateModified":"2023-07-20T00:00:00+07:00","datePublished":"2023-07-20T00:00:00+07:00","description":"Với mỗi Miner, họ sẽ thông thường được connect với 8 người khác. Khi một Tx được gửi đến, Miners sẽ thông báo là nhận được Tx trên mạng P2P. Mọi miners sẽ xác thực rằng Tx đã nhận và lưu vào trong Mempool. Mempool là nơi chứa những Tx đang chờ được xử lý. Các nodes này chia sẻ dữ liệu mempool với nhau bằng cách chuyển tiếp các Tx đã kí với nhau cho đến khi nó được toàn bộ mạng lưới.","headline":"Cơ chế Bitcoin","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/2023/07/20/co-che-Bitcoin"},"url":"http://localhost:4000/blog/2023/07/20/co-che-Bitcoin"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <div class="header">
  <div class = "tab_container">
      
        <a href="/" 
        
        class = "tab_btn">
        Home
        </a>
      
        <a href="/about.html" 
        
        class = "tab_btn">
        About
        </a>
      
        <a href="/blog.html" 
        
        class = "tab_btn">
        Blog
        </a>
      
        <a href="/staff.html" 
        
        class = "tab_btn">
        Staff
        </a>
      
  </div>
</div>

    <div class = "default_content">
        <h1 class = "post_title">Cơ chế Bitcoin</h1>
        <p class = "post_detail">
            vanhg - 20 Jul 2023 
        </p>
        <div class = "img_container">
            <img src =  class = "post_img">
        </div>
        <div class = "post_content">
          <p>Với mỗi Miner, họ sẽ thông thường được connect với 8 người khác. Khi một Tx được gửi đến, Miners sẽ thông báo là nhận được Tx trên mạng P2P. Mọi miners sẽ xác thực rằng Tx đã nhận và lưu vào trong Mempool. Mempool là nơi chứa những Tx đang chờ được xử lý. Các nodes này chia sẻ dữ liệu mempool với nhau bằng cách chuyển tiếp các Tx đã kí với nhau cho đến khi nó được toàn bộ mạng lưới.</p>

<h3 id="thời-gian-đóng-các-khối">Thời gian đóng các khối</h3>
<p>Cứ sau mỗi 10 phút, mỗi miner sẽ tạo 1 block tiềm năng từ các Tx trong mempool của nó. Các Tx được ưu tiên theo phí giao dịch. 1 miner được chọn (sau khi giải được bài toán PoW) sẽ phân tán block đó cho toàn mạng và mọi miner khác sẽ xem được block, sau đó block được đưa vào chuỗi. Phần thưởng là 6.25 BTC. Phần thưởng này được gửi cho miner thông qua coinbase Tx (là Tx đầu tiên trong block chứa địa chỉ ví của miner do ,miner thêm vào).</p>

<h2 id="cấu-trúc-của-một-transaction">Cấu trúc của một Transaction</h2>
<p>Transaction trong Bitcoin chia làm 2 phần chính là Input và Output.
Input gồm 3 phần chính:</p>
<ul>
  <li>Previous Tx ID: ID của Tx trước đó mà tạo ra Bitcoin ở Output để sử dụng trong giao dịch hiện tại.</li>
  <li>Previous Tx index: Vì một Tx có thể có nhiều Output nên index này được sử dụng để xác định output trong Tx trước đó. Danh sách các output được xem như 1 tập hợp bên trong Tx.</li>
  <li>ScriptSig: Script Signature. Nó mã hoá Public key và chữ kí của người sở hữu Bitcoin ở hiện tại.</li>
</ul>

<p>Output: là những bitcoin mới được khoá với Hash của Public Key của người nhận. Bitcoin sử dụng mô hình UTXO là Bitcoin chỉ có thể sử dụng 1 lần, sau mỗi giao dịch thì bitcoin cũ sẽ bị loại bỏ và một lượng bitcoin mới được tạo ra. Output gồm 2 phần chính:</p>
<ul>
  <li>Value: Số lượng bitcoin mà được gửi cho người nhận. (Min: 1 satoshi = 10^-8 BTC)</li>
  <li>ScriptPubKey: Là một dãy các chỉ dẫn (Như 1 hàm) mà nhận ScriptSig là Input và trả về True nếu người sở hữu hợp lệ mở khoá Bitcoin này. Ngược lại, nó trả về false.</li>
</ul>

<p>Một giao dịch có thể có nhiều Input và Output. Các input có thể từ nhiều user (gọi là MultiSig Tx), các output có thể đến nhiều user.</p>

<p>Ngoài ra, trong Tx còn có 2 phần khác là segwit và locktime.</p>

<h3 id="miner-xác-minh-một-tx-như-thế-nào">Miner xác minh một Tx như thế nào</h3>
<p>Một Tx thoả mãn khi:</p>
<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ScriptSig</td>
          <td>ScriptPK trả về True. Tức là với điều kiện nào thì UTXO có thể được tiêu.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>TxID</td>
          <td>index: hiện ở trong tập các UTXO</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>tổng Input values &gt; tổng Output values: Không thể tiêu nhiều hơn số tiền đang có.
Sau khi 1 Tx được post lên, miners sẽ xoá UTXO tương ứng của nó trong tập.</li>
</ul>

<h2 id="các-loại-tx">Các loại Tx</h2>
<h3 id="pay-to-public-key-hash-p2pkh">Pay to public key hash (P2PKH)</h3>
<p>Trước tiên, mọi người cần hiểu về một số op codes hoạt động trong Bitcoin Script ở <a href="https://wiki.bitcoinsv.io/index.php/Opcodes_used_in_Bitcoin_Script">đây</a>. 
Giả sử Alice muốn gửi cho Bob 5BTC. Alice và Bob sẽ làm các bước sau:</p>
<ul>
  <li>Bob tạo sig : gọi Gen():  (pkB, skB)</li>
  <li>Bob tính địa chỉ bitcoin của mình bằng: addrB = H(pkB)</li>
  <li>Bob gửi addrB cho Alice</li>
  <li>
    <p>Alice tạo giao dịch Tx-fund với Output[0] là: UTXO[0]: 5, ScriptPkB với ScriptPkB là:</p>

    <p>DUP  HASH256  «addrB»  EQVERIFY  CHECKSIG</p>
  </li>
</ul>

<p>còn ở Input, Alice có ScriptSig để xác thực Bitcoin của Alice có chứa chữ ký của Alice lên Tx này, khiến cho không ai có quyền thay đổi ScriptPkB.</p>

<p>Sau đó, Bob muốn sử dụng UTXO[0] thì sẽ tạo 1 Tx-spend với ScriptSigB trong input, bao gồm «sig» và «pkB» với Sig = Sig(skB, Tx) (Tx này là Tx-spend nhưng không chứa các ScriptSig).</p>

<p>Miner có thể xác thực ScriptSigB|ScriptPkB = true và cho phép B sử dụng số tiền.
Một số lưu ý như:</p>
<ul>
  <li>Người nhận (Bob) không thể tiết lộ PkB cho đến khi UTXO được dùng (vì bảo mật).</li>
  <li>Vì tránh việc tấn công bằng cách thay đổi Sig, Sig được chuyển vào phần witness và TxID được tính bằng:               TxID = H(Tx không chứa witness).</li>
</ul>

<h3 id="pay-to-script-hash-p2sh">Pay to script hash (P2SH)</h3>
<p>Người nhận (Bob) thay vì tạo address là H(pkB) thì tạo 1 redeem script, sau đó gán địa chỉ để người gửi (Alice) chuyển qua thành H(redeem script).
Ví dụ:</p>
<ul>
  <li>ScriptPK ở UTXO: HASH160   «H(redeem script)»  EQUAL</li>
  <li>ScriptSig để tiêu: {sig1 , sig2, …, sign, redeem script}
Từ đây, người gửi (Alice) có thể thêm các điều kiện phức tạp để xác định khi nào người nhận (Bob) có thể tiêu.</li>
</ul>

<p>Reedem Script: là các điều kiện thoả mãn để có thể sử dụng UTXO như: số chữ kí tối thiểu, thời gian,…</p>

<p>Các miner xác minh bằng cách:</p>
<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ScriptSig</td>
          <td>ScriptPk = true: Bob gửi đúng script.</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>ScriptSig = true: script là thoả mãn (tức là sẽ tồn tại điều kiện để Bob có thể dùng UTXO).</li>
</ul>

<h4 id="ví-dụ-multisig">Ví dụ: MultiSig</h4>
<p>Muốn dùng UTXO thì cần t/n chữ kí. Ví dụ với 2 / 3 chữ kí. Redeem Script và ScriptSig được viết như sau:</p>
<ul>
  <li>Redeem Script: 	2, PK1, PK2, PK3, 3, CHECKMULTISIG</li>
  <li>ScriptSig: 0, sig1, sig3, redeem script</li>
</ul>

<h2 id="kết-luận">Kết luận</h2>
<p>Ngoài những dạng Tx ở trên, sẽ có nhiều dạng Tx khác được sử dụng ở trong nhiều trường hợp cụ thể.</p>


        </div>
        
    </div>
  </body>
  <footer>
    
  </footer>
</html>  